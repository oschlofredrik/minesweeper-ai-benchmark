<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Minesweeper AI Benchmark</title>
    <link rel="stylesheet" href="/static/rams-design.css">
    <style>
        /* Admin-specific styles */
        .admin-nav {
            display: flex;
            gap: var(--unit);
            margin-bottom: calc(var(--unit) * 4);
            border-bottom: 1px solid var(--border);
        }
        
        .admin-nav button {
            background: none;
            border: none;
            padding: calc(var(--unit) * 2) calc(var(--unit) * 3);
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
            transition: color var(--transition);
        }
        
        .admin-nav button:hover {
            color: var(--text-primary);
        }
        
        .admin-nav button.active {
            color: var(--text-primary);
        }
        
        .admin-nav button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--text-primary);
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .editor-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: calc(var(--unit) * 4);
        }
        
        .list-item {
            padding: calc(var(--unit) * 2);
            border: 1px solid var(--border);
            margin-bottom: var(--unit);
            cursor: pointer;
            transition: background-color var(--transition);
        }
        
        .list-item:hover {
            background-color: var(--bg-secondary);
        }
        
        .list-item.active {
            background-color: var(--bg-secondary);
            border-color: var(--text-primary);
        }
        
        .badge {
            display: inline-block;
            padding: calc(var(--unit) * 0.5) var(--unit);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: var(--bg-secondary);
            margin-left: var(--unit);
        }
        
        .badge.active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: var(--unit);
        }
        
        .toggle-switch input[type="checkbox"] {
            width: auto;
        }
        
        .message {
            padding: calc(var(--unit) * 2);
            margin-bottom: calc(var(--unit) * 2);
            border: 1px solid;
            background: var(--bg-secondary);
        }
        
        .message.success {
            border-color: var(--text-primary);
        }
        
        .message.error {
            border-color: var(--gray-600);
            color: var(--gray-600);
        }
        
        .code-preview {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: var(--text-sm);
            background: var(--bg-secondary);
            padding: calc(var(--unit) * 2);
            border: 1px solid var(--border);
            overflow-x: auto;
        }
        
        .actions {
            display: flex;
            gap: var(--unit);
            margin-top: calc(var(--unit) * 3);
        }
        
        @media (max-width: 768px) {
            .editor-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <header class="header">
            <h1 style="font-size: var(--text-lg); font-weight: 500; margin: 0;">Admin Panel</h1>
        </header>
        
        <aside class="sidebar">
            <nav class="nav">
                <a href="/" class="nav-link">‚Üê Back to Benchmark</a>
                <a href="/docs" class="nav-link">API Documentation</a>
            </nav>
        </aside>
        
        <main class="main">
            <div id="message-container"></div>
            
            <nav class="admin-nav">
                <button class="active" onclick="showTab('prompts')">Prompts</button>
                <button onclick="showTab('models')">Models</button>
                <button onclick="showTab('settings')">Settings</button>
                <button onclick="showTab('features')">Features</button>
                <button onclick="showTab('database')">Database</button>
                <button onclick="showTab('export')">Export/Import</button>
            </nav>
            
            <!-- Prompts Tab -->
            <div id="prompts-panel" class="tab-panel active">
                <div class="mb-3">
                    <button class="button button-secondary" onclick="createNewPrompt()">+ New Prompt</button>
                    <button class="button button-secondary" onclick="loadPrompts()">Refresh</button>
                </div>
                
                <div class="editor-grid">
                    <div>
                        <h3>Templates</h3>
                        <div id="prompt-list">
                            <p class="text-muted">Loading prompts...</p>
                        </div>
                    </div>
                    
                    <div id="prompt-editor" style="display: none;">
                        <h3>Edit Template</h3>
                        <form id="prompt-form">
                            <input type="hidden" id="prompt-id">
                            
                            <div class="form-group">
                                <label class="label" for="prompt-name">Name</label>
                                <input type="text" class="input" id="prompt-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="label" for="prompt-description">Description</label>
                                <input type="text" class="input" id="prompt-description" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="label" for="prompt-system">System Prompt</label>
                                <textarea class="textarea" id="prompt-system" rows="6" required></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="label" for="prompt-user">User Prompt Template</label>
                                <textarea class="textarea" id="prompt-user" rows="8" required placeholder="Use {board_state} as placeholder"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="prompt-function-calling">
                                    <label for="prompt-function-calling">Supports Function Calling</label>
                                </div>
                                
                                <div class="toggle-switch mt-2">
                                    <input type="checkbox" id="prompt-active">
                                    <label for="prompt-active">Active</label>
                                </div>
                            </div>
                            
                            <div class="actions">
                                <button type="submit" class="button">Save Template</button>
                                <button type="button" class="button button-secondary" onclick="cancelEdit()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Models Tab -->
            <div id="models-panel" class="tab-panel">
                <div class="mb-3">
                    <button class="button button-secondary" onclick="createNewModel()">+ New Model</button>
                    <button class="button button-secondary" onclick="loadModels()">Refresh</button>
                </div>
                
                <div class="editor-grid">
                    <div>
                        <h3>Configured Models</h3>
                        <div id="model-list">
                            <p class="text-muted">Loading models...</p>
                        </div>
                    </div>
                    
                    <div id="model-editor" style="display: none;">
                        <h3>Edit Model</h3>
                        <form id="model-form">
                            <input type="hidden" id="model-original-name">
                            
                            <div class="form-group">
                                <label class="label" for="model-name">Name</label>
                                <input type="text" class="input" id="model-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="label" for="model-provider">Provider</label>
                                <select class="select" id="model-provider" required>
                                    <option value="">Select provider...</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Anthropic</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="label" for="model-id">Model ID</label>
                                <input type="text" class="input" id="model-id" required placeholder="e.g., gpt-4, claude-3-opus-20240229">
                            </div>
                            
                            <div class="form-group">
                                <label class="label" for="model-temperature">Temperature</label>
                                <input type="number" class="input" id="model-temperature" min="0" max="2" step="0.1" value="0">
                            </div>
                            
                            <div class="form-group">
                                <label class="label" for="model-max-tokens">Max Tokens</label>
                                <input type="number" class="input" id="model-max-tokens" min="1" max="4096" value="1000">
                            </div>
                            
                            <div class="form-group">
                                <label class="label" for="model-api-key">API Key (optional)</label>
                                <input type="password" class="input" id="model-api-key" placeholder="Leave blank to use environment variable">
                            </div>
                            
                            <div class="form-group">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="model-enabled" checked>
                                    <label for="model-enabled">Enabled</label>
                                </div>
                            </div>
                            
                            <div class="actions">
                                <button type="submit" class="button">Save Model</button>
                                <button type="button" class="button button-secondary" onclick="cancelModelEdit()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <h3>API Key Status</h3>
                    <div id="api-key-status">
                        <p class="text-muted">Loading API key status...</p>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings-panel" class="tab-panel">
                <h3>System Settings</h3>
                <div id="settings-list">
                    <p class="text-muted">Loading settings...</p>
                </div>
            </div>
            
            <!-- Features Tab -->
            <div id="features-panel" class="tab-panel">
                <h3>Feature Toggles</h3>
                <div id="features-list">
                    <p class="text-muted">Loading features...</p>
                </div>
            </div>
            
            <!-- Database Tab -->
            <div id="database-panel" class="tab-panel">
                <div class="mb-3">
                    <h3>Database Overview</h3>
                    <div id="db-stats" class="card">
                        <p class="text-muted">Loading database statistics...</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h3>Games Management</h3>
                    <div class="mb-3">
                        <button class="button button-secondary" onclick="loadDatabaseGames()">Refresh Games</button>
                        <button class="button button-secondary" onclick="showCleanupDialog()">Cleanup Database</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Filter Games</label>
                        <div class="grid grid-cols-3 gap-2">
                            <select class="select" id="db-filter-model" onchange="loadDatabaseGames()">
                                <option value="">All Models</option>
                            </select>
                            <select class="select" id="db-filter-provider" onchange="loadDatabaseGames()">
                                <option value="">All Providers</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                            </select>
                            <select class="select" id="db-filter-won" onchange="loadDatabaseGames()">
                                <option value="">All Games</option>
                                <option value="true">Won</option>
                                <option value="false">Lost</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="db-games-list" class="mt-3">
                        <p class="text-muted">No games loaded</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h3>Leaderboard Management</h3>
                    <div id="db-leaderboard-list">
                        <p class="text-muted">Loading leaderboard...</p>
                    </div>
                </div>
                
                <!-- Cleanup Dialog -->
                <div id="cleanup-dialog" class="card" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: var(--bg-primary); border: 2px solid var(--text-primary); padding: calc(var(--unit) * 4); min-width: 400px;">
                    <h3>Database Cleanup</h3>
                    <div class="form-group">
                        <div class="toggle-switch mb-2">
                            <input type="checkbox" id="cleanup-orphaned">
                            <label for="cleanup-orphaned">Delete orphaned evaluations</label>
                        </div>
                        <div class="toggle-switch mb-2">
                            <input type="checkbox" id="cleanup-empty">
                            <label for="cleanup-empty">Delete games without moves</label>
                        </div>
                        <div class="toggle-switch mb-2">
                            <input type="checkbox" id="cleanup-tasks">
                            <label for="cleanup-tasks">Delete unused tasks</label>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="button" onclick="performCleanup()">Perform Cleanup</button>
                        <button class="button button-secondary" onclick="hideCleanupDialog()">Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- Export/Import Tab -->
            <div id="export-panel" class="tab-panel">
                <div class="grid grid-cols-2">
                    <div class="card">
                        <h3>Export Configuration</h3>
                        <p class="text-muted mb-3">Download all prompts, settings, and feature toggles as a JSON file.</p>
                        <button class="button button-secondary" onclick="exportConfig()">Export Configuration</button>
                    </div>
                    
                    <div class="card">
                        <h3>Import Configuration</h3>
                        <p class="text-muted mb-3">Upload a JSON configuration file to restore prompts, settings, and features.</p>
                        <div class="form-group">
                            <input type="file" id="import-file" accept=".json">
                        </div>
                        <button class="button button-secondary" onclick="importConfig()">Import Configuration</button>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h3>Configuration Preview</h3>
                    <pre id="config-preview" class="code-preview" style="display: none;"></pre>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // Global state
        let currentPromptId = null;
        let currentModelName = null;
        let prompts = {};
        let models = {};
        let settings = {};
        let features = {};
        
        // Tab switching
        function showTab(tabName) {
            // Update nav buttons
            document.querySelectorAll('.admin-nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(tabName + '-panel').classList.add('active');
            
            // Load data for the tab
            if (tabName === 'prompts') {
                loadPrompts();
            } else if (tabName === 'models') {
                loadModels();
                loadApiKeyStatus();
            } else if (tabName === 'settings') {
                loadSettings();
            } else if (tabName === 'features') {
                loadFeatures();
            } else if (tabName === 'database') {
                loadDatabaseStats();
                loadDatabaseGames();
                loadDatabaseLeaderboard();
            }
        }
        
        // Message display
        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-container');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = message;
            container.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 5000);
        }
        
        // Prompts management
        async function loadPrompts() {
            try {
                const response = await fetch('/api/admin/prompts');
                const data = await response.json();
                prompts = {};
                data.prompts.forEach(p => {
                    prompts[p.id] = p;
                });
                displayPrompts();
            } catch (error) {
                showMessage('Failed to load prompts: ' + error.message, 'error');
            }
        }
        
        function displayPrompts() {
            const list = document.getElementById('prompt-list');
            list.innerHTML = '';
            
            Object.values(prompts).forEach(prompt => {
                const div = document.createElement('div');
                div.className = 'list-item';
                if (prompt.id === currentPromptId) {
                    div.classList.add('active');
                }
                
                let badges = '';
                if (prompt.is_active) badges += '<span class="badge active">ACTIVE</span>';
                if (prompt.supports_function_calling) badges += '<span class="badge">FUNCTION CALLING</span>';
                
                div.innerHTML = `
                    <h4 style="font-weight: 500; margin-bottom: var(--unit);">${prompt.name}</h4>
                    <p class="text-sm text-muted" style="margin: 0;">${prompt.description}</p>
                    ${badges}
                `;
                
                div.onclick = () => editPrompt(prompt.id);
                list.appendChild(div);
            });
        }
        
        async function editPrompt(promptId) {
            try {
                const response = await fetch(`/api/admin/prompts/${promptId}`);
                const prompt = await response.json();
                
                currentPromptId = promptId;
                document.getElementById('prompt-id').value = prompt.id;
                document.getElementById('prompt-name').value = prompt.name;
                document.getElementById('prompt-description').value = prompt.description;
                document.getElementById('prompt-system').value = prompt.system_prompt;
                document.getElementById('prompt-user').value = prompt.user_prompt_template;
                document.getElementById('prompt-function-calling').checked = prompt.supports_function_calling;
                document.getElementById('prompt-active').checked = prompt.is_active;
                
                document.getElementById('prompt-editor').style.display = 'block';
                displayPrompts();
            } catch (error) {
                showMessage('Failed to load prompt: ' + error.message, 'error');
            }
        }
        
        function createNewPrompt() {
            currentPromptId = null;
            document.getElementById('prompt-form').reset();
            document.getElementById('prompt-id').value = '';
            document.getElementById('prompt-active').checked = true;
            document.getElementById('prompt-editor').style.display = 'block';
        }
        
        function cancelEdit() {
            currentPromptId = null;
            document.getElementById('prompt-editor').style.display = 'none';
            displayPrompts();
        }
        
        document.getElementById('prompt-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const promptId = document.getElementById('prompt-id').value;
            const data = {
                name: document.getElementById('prompt-name').value,
                description: document.getElementById('prompt-description').value,
                system_prompt: document.getElementById('prompt-system').value,
                user_prompt_template: document.getElementById('prompt-user').value,
                supports_function_calling: document.getElementById('prompt-function-calling').checked,
                is_active: document.getElementById('prompt-active').checked
            };
            
            try {
                const url = promptId 
                    ? `/api/admin/prompts/${promptId}`
                    : '/api/admin/prompts';
                const method = promptId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showMessage('Prompt saved successfully');
                    loadPrompts();
                    cancelEdit();
                } else {
                    const error = await response.json();
                    showMessage('Failed to save prompt: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('Failed to save prompt: ' + error.message, 'error');
            }
        };
        
        // Models management
        async function loadModels() {
            try {
                const response = await fetch('/api/admin/models');
                const data = await response.json();
                models = {};
                data.models.forEach(m => {
                    models[m.name] = m;
                });
                displayModels();
            } catch (error) {
                showMessage('Failed to load models: ' + error.message, 'error');
            }
        }
        
        function displayModels() {
            const list = document.getElementById('model-list');
            list.innerHTML = '';
            
            Object.values(models).forEach(model => {
                const div = document.createElement('div');
                div.className = 'list-item';
                if (model.name === currentModelName) {
                    div.classList.add('active');
                }
                
                let badges = '';
                if (model.enabled) badges += '<span class="badge active">ENABLED</span>';
                badges += `<span class="badge">${model.provider.toUpperCase()}</span>`;
                
                div.innerHTML = `
                    <h4 style="font-weight: 500; margin-bottom: var(--unit);">${model.name}</h4>
                    <p class="text-sm text-muted" style="margin: 0;">${model.model_id} ‚Ä¢ Temperature: ${model.temperature}</p>
                    ${badges}
                `;
                
                div.onclick = () => editModel(model.name);
                list.appendChild(div);
            });
        }
        
        async function editModel(modelName) {
            try {
                const response = await fetch(`/api/admin/models/${modelName}`);
                const model = await response.json();
                
                currentModelName = modelName;
                document.getElementById('model-original-name').value = modelName;
                document.getElementById('model-name').value = model.name;
                document.getElementById('model-provider').value = model.provider;
                document.getElementById('model-id').value = model.model_id;
                document.getElementById('model-temperature').value = model.temperature;
                document.getElementById('model-max-tokens').value = model.max_tokens;
                document.getElementById('model-enabled').checked = model.enabled;
                document.getElementById('model-api-key').value = '';
                
                document.getElementById('model-editor').style.display = 'block';
                displayModels();
            } catch (error) {
                showMessage('Failed to load model: ' + error.message, 'error');
            }
        }
        
        function createNewModel() {
            currentModelName = null;
            document.getElementById('model-form').reset();
            document.getElementById('model-original-name').value = '';
            document.getElementById('model-enabled').checked = true;
            document.getElementById('model-editor').style.display = 'block';
        }
        
        function cancelModelEdit() {
            currentModelName = null;
            document.getElementById('model-editor').style.display = 'none';
            displayModels();
        }
        
        document.getElementById('model-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const originalName = document.getElementById('model-original-name').value;
            const data = {
                name: document.getElementById('model-name').value,
                provider: document.getElementById('model-provider').value,
                model_id: document.getElementById('model-id').value,
                temperature: parseFloat(document.getElementById('model-temperature').value),
                max_tokens: parseInt(document.getElementById('model-max-tokens').value),
                enabled: document.getElementById('model-enabled').checked,
                api_key: document.getElementById('model-api-key').value || null
            };
            
            try {
                const url = originalName 
                    ? `/api/admin/models/${originalName}`
                    : '/api/admin/models';
                const method = originalName ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showMessage('Model saved successfully');
                    loadModels();
                    cancelModelEdit();
                } else {
                    const error = await response.json();
                    showMessage('Failed to save model: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('Failed to save model: ' + error.message, 'error');
            }
        };
        
        async function loadApiKeyStatus() {
            try {
                const response = await fetch('/api/admin/api-keys');
                const data = await response.json();
                
                const container = document.getElementById('api-key-status');
                container.innerHTML = '';
                
                Object.entries(data).forEach(([provider, info]) => {
                    const div = document.createElement('div');
                    div.className = 'mb-3';
                    div.innerHTML = `
                        <h4 style="font-weight: 500; text-transform: capitalize;">${provider}</h4>
                        <p class="text-sm text-muted">
                            ${info.configured ? `Configured: ${info.key_prefix}` : 'Not configured'}
                        </p>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                showMessage('Failed to load API key status: ' + error.message, 'error');
            }
        }
        
        // Settings management
        async function loadSettings() {
            try {
                const response = await fetch('/api/admin/settings');
                const data = await response.json();
                settings = data.settings;
                displaySettings();
            } catch (error) {
                showMessage('Failed to load settings: ' + error.message, 'error');
            }
        }
        
        function displaySettings() {
            const container = document.getElementById('settings-list');
            container.innerHTML = '';
            
            Object.entries(settings).forEach(([key, setting]) => {
                const div = document.createElement('div');
                div.className = 'form-group';
                
                const inputType = setting.type === 'int' || setting.type === 'float' ? 'number' : 'text';
                const step = setting.type === 'float' ? '0.1' : '1';
                
                if (setting.type === 'bool') {
                    div.innerHTML = `
                        <div class="toggle-switch">
                            <input type="checkbox" id="setting-${key}" 
                                   ${setting.value ? 'checked' : ''}
                                   onchange="updateSetting('${key}', this.checked)">
                            <label for="setting-${key}">${setting.description}</label>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <label class="label" for="setting-${key}">${setting.description}</label>
                        <input type="${inputType}" 
                               class="input"
                               id="setting-${key}" 
                               value="${setting.value}"
                               step="${step}"
                               onchange="updateSetting('${key}', this.value)">
                    `;
                }
                
                container.appendChild(div);
            });
        }
        
        async function updateSetting(key, value) {
            try {
                const response = await fetch(`/api/admin/settings/${key}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        key: key,
                        value: value
                    })
                });
                
                if (response.ok) {
                    showMessage('Setting updated successfully');
                    settings[key].value = value;
                } else {
                    const error = await response.json();
                    showMessage('Failed to update setting: ' + error.detail, 'error');
                    loadSettings();
                }
            } catch (error) {
                showMessage('Failed to update setting: ' + error.message, 'error');
                loadSettings();
            }
        }
        
        // Features management
        async function loadFeatures() {
            try {
                const response = await fetch('/api/admin/features');
                const data = await response.json();
                features = {};
                data.features.forEach(f => {
                    features[f.key] = f;
                });
                displayFeatures();
            } catch (error) {
                showMessage('Failed to load features: ' + error.message, 'error');
            }
        }
        
        function displayFeatures() {
            const container = document.getElementById('features-list');
            container.innerHTML = '';
            
            Object.values(features).forEach(feature => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <div class="toggle-switch">
                        <input type="checkbox" 
                               id="feature-${feature.key}" 
                               ${feature.enabled ? 'checked' : ''}
                               onchange="toggleFeature('${feature.key}', this.checked)">
                        <label for="feature-${feature.key}">
                            <strong>${feature.name}</strong>
                            <p class="text-sm text-muted mt-1">${feature.description}</p>
                        </label>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        async function toggleFeature(key, enabled) {
            try {
                const response = await fetch(`/api/admin/features/${key}?enabled=${enabled}`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    showMessage('Feature updated successfully');
                    features[key].enabled = enabled;
                } else {
                    const error = await response.json();
                    showMessage('Failed to update feature: ' + error.detail, 'error');
                    document.getElementById(`feature-${key}`).checked = !enabled;
                }
            } catch (error) {
                showMessage('Failed to update feature: ' + error.message, 'error');
                document.getElementById(`feature-${key}`).checked = !enabled;
            }
        }
        
        // Export/Import
        async function exportConfig() {
            try {
                const response = await fetch('/api/admin/export');
                const config = await response.json();
                
                // Show preview
                document.getElementById('config-preview').textContent = JSON.stringify(config, null, 2);
                document.getElementById('config-preview').style.display = 'block';
                
                // Download file
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `minesweeper-config-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showMessage('Configuration exported successfully');
            } catch (error) {
                showMessage('Failed to export configuration: ' + error.message, 'error');
            }
        }
        
        async function importConfig() {
            const fileInput = document.getElementById('import-file');
            if (!fileInput.files.length) {
                showMessage('Please select a file to import', 'error');
                return;
            }
            
            try {
                const file = fileInput.files[0];
                const text = await file.text();
                const config = JSON.parse(text);
                
                // Show preview
                document.getElementById('config-preview').textContent = JSON.stringify(config, null, 2);
                document.getElementById('config-preview').style.display = 'block';
                
                // Import the configuration
                const response = await fetch('/api/admin/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: text
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`Configuration imported successfully: ${JSON.stringify(result.imported)}`);
                    // Reload current tab
                    const activeTab = document.querySelector('.admin-nav button.active').textContent.toLowerCase();
                    if (activeTab === 'prompts') loadPrompts();
                    else if (activeTab === 'models') loadModels();
                    else if (activeTab === 'settings') loadSettings();
                    else if (activeTab === 'features') loadFeatures();
                } else {
                    const error = await response.json();
                    showMessage('Failed to import configuration: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('Failed to import configuration: ' + error.message, 'error');
            }
        }
        
        // Database management functions
        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/admin/database/stats');
                const stats = await response.json();
                
                const container = document.getElementById('db-stats');
                container.innerHTML = `
                    <div class="grid grid-cols-4 gap-3">
                        <div>
                            <h4 class="text-sm text-muted">Total Games</h4>
                            <p class="text-2xl">${stats.games.total}</p>
                        </div>
                        <div>
                            <h4 class="text-sm text-muted">Won Games</h4>
                            <p class="text-2xl">${stats.games.won}</p>
                        </div>
                        <div>
                            <h4 class="text-sm text-muted">Leaderboard Entries</h4>
                            <p class="text-2xl">${stats.leaderboard_entries}</p>
                        </div>
                        <div>
                            <h4 class="text-sm text-muted">Tasks</h4>
                            <p class="text-2xl">${stats.tasks}</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h4 class="text-sm text-muted mb-2">Games by Model</h4>
                        <div class="grid grid-cols-2 gap-2">
                            ${Object.entries(stats.games.by_model).map(([model, data]) => `
                                <div class="text-sm">
                                    <span class="text-muted">${model}:</span> ${data.total} games (${data.won} won)
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // Update model filter options
                const modelSelect = document.getElementById('db-filter-model');
                modelSelect.innerHTML = '<option value="">All Models</option>';
                stats.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.provider}:${model.name}`;
                    modelSelect.appendChild(option);
                });
                
            } catch (error) {
                showMessage('Failed to load database stats: ' + error.message, 'error');
            }
        }
        
        async function loadDatabaseGames() {
            try {
                const modelFilter = document.getElementById('db-filter-model').value;
                const providerFilter = document.getElementById('db-filter-provider').value;
                const wonFilter = document.getElementById('db-filter-won').value;
                
                let url = '/api/admin/database/games?limit=50';
                if (modelFilter) url += `&model_name=${modelFilter}`;
                if (providerFilter) url += `&provider=${providerFilter}`;
                if (wonFilter) url += `&won=${wonFilter}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                const container = document.getElementById('db-games-list');
                if (data.games.length === 0) {
                    container.innerHTML = '<p class="text-muted">No games found</p>';
                    return;
                }
                
                container.innerHTML = `
                    <p class="text-sm text-muted mb-2">Showing ${data.games.length} of ${data.total} games</p>
                    <div class="space-y-2">
                        ${data.games.map(game => `
                            <div class="list-item">
                                <div class="flex justify-between align-items-center">
                                    <div>
                                        <strong>${game.model}</strong> ‚Ä¢ ${game.difficulty} ‚Ä¢ ${game.board_size} ‚Ä¢ ${game.mines} mines
                                        <br>
                                        <span class="text-sm text-muted">
                                            ${game.won ? '‚úì Won' : '‚úó Lost'} ‚Ä¢ ${game.moves} moves ‚Ä¢ ${game.created_at ? new Date(game.created_at).toLocaleString() : 'Unknown date'}
                                            ${game.has_transcript ? ' ‚Ä¢ üìù Transcript' : ''}
                                        </span>
                                    </div>
                                    <button class="button button-secondary" onclick="deleteGame('${game.id}')">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                showMessage('Failed to load games: ' + error.message, 'error');
            }
        }
        
        async function loadDatabaseLeaderboard() {
            try {
                const response = await fetch('/api/admin/database/leaderboard');
                const entries = await response.json();
                
                const container = document.getElementById('db-leaderboard-list');
                if (entries.length === 0) {
                    container.innerHTML = '<p class="text-muted">No leaderboard entries</p>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="space-y-2">
                        ${entries.map(entry => `
                            <div class="list-item">
                                <div class="flex justify-between align-items-center">
                                    <div>
                                        <strong>${entry.model}</strong>
                                        <br>
                                        <span class="text-sm text-muted">
                                            ${entry.total_games} games ‚Ä¢ Win rate: ${(entry.win_rate * 100).toFixed(1)}% ‚Ä¢ 
                                            Global score: ${entry.global_score.toFixed(4)} ‚Ä¢ 
                                            Reasoning: ${entry.reasoning_score.toFixed(2)}
                                        </span>
                                    </div>
                                    <div>
                                        <button class="button button-secondary" onclick="resetModelStats('${entry.model_name}', '${entry.provider}')">Reset</button>
                                        <button class="button button-secondary" onclick="deleteLeaderboardEntry(${entry.id})">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                showMessage('Failed to load leaderboard: ' + error.message, 'error');
            }
        }
        
        async function deleteGame(gameId) {
            if (!confirm('Are you sure you want to delete this game?')) return;
            
            try {
                const response = await fetch(`/api/admin/database/games/${gameId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('Game deleted successfully');
                    loadDatabaseGames();
                    loadDatabaseStats();
                } else {
                    const error = await response.json();
                    showMessage('Failed to delete game: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('Failed to delete game: ' + error.message, 'error');
            }
        }
        
        async function deleteLeaderboardEntry(entryId) {
            if (!confirm('Are you sure you want to delete this leaderboard entry?')) return;
            
            try {
                const response = await fetch(`/api/admin/database/leaderboard/${entryId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('Leaderboard entry deleted successfully');
                    loadDatabaseLeaderboard();
                    loadDatabaseStats();
                } else {
                    const error = await response.json();
                    showMessage('Failed to delete entry: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('Failed to delete entry: ' + error.message, 'error');
            }
        }
        
        async function resetModelStats(modelName, provider) {
            if (!confirm(`Are you sure you want to reset all stats for ${provider}:${modelName}?\nThis will delete all games and leaderboard data.`)) return;
            
            try {
                const response = await fetch(`/api/admin/database/leaderboard/reset/${modelName}?provider=${provider}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`Reset complete: ${result.games_deleted} games deleted`);
                    loadDatabaseStats();
                    loadDatabaseGames();
                    loadDatabaseLeaderboard();
                } else {
                    const error = await response.json();
                    showMessage('Failed to reset stats: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('Failed to reset stats: ' + error.message, 'error');
            }
        }
        
        function showCleanupDialog() {
            document.getElementById('cleanup-dialog').style.display = 'block';
        }
        
        function hideCleanupDialog() {
            document.getElementById('cleanup-dialog').style.display = 'none';
        }
        
        async function performCleanup() {
            try {
                const params = {
                    delete_orphaned_evaluations: document.getElementById('cleanup-orphaned').checked,
                    delete_games_without_moves: document.getElementById('cleanup-empty').checked,
                    delete_old_tasks: document.getElementById('cleanup-tasks').checked
                };
                
                const response = await fetch('/api/admin/database/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`Cleanup complete: ${JSON.stringify(result.stats)}`);
                    hideCleanupDialog();
                    loadDatabaseStats();
                    loadDatabaseGames();
                } else {
                    const error = await response.json();
                    showMessage('Failed to perform cleanup: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('Failed to perform cleanup: ' + error.message, 'error');
            }
        }
        
        // Initialize on load
        loadPrompts();
    </script>
</body>
</html>